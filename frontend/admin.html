<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Milqu Fresh â€” Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0a0f0d; --bg2: #656c68; --bg3: #142019; --card: #111a15;
      --border: #1e2e22; --green: #f0f0f0; --green2: #16a34a;
      --green-dim: rgba(222, 222, 222, 0.12); --green-glow: rgba(234, 234, 234, 0.25);
      --amber: #f59e0b; --red: #ef4444; --blue: #3b82f6;
      --text: #e2f0e8; --text2: #7a9a82; --text3: #4a6a52;
      --white: #fff; --radius: 12px; --mono: 'DM Mono', monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Syne', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; overflow: hidden; }

    /* â”€â”€ SIDEBAR â”€â”€ */
    .sidebar { width: 220px; flex-shrink: 0; background: var(--bg2); border-right: 1px solid var(--border); display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; }
    .sidebar-logo { padding: 22px 20px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
    .logo-mark { width: 34px; height: 34px; background: var(--green); border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .logo-name { font-size: 16px; font-weight: 800; letter-spacing: -.3px; }
    .logo-name span { color: var(--green); }
    .logo-sub { font-size: 10px; color: var(--text3); font-family: var(--mono); text-transform: uppercase; letter-spacing: 1px; margin-top: 1px; }
    .nav { flex: 1; padding: 16px 10px; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; }
    .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 9px; cursor: pointer; font-size: 14px; font-weight: 500; color: var(--text2); transition: all .2s; border: none; background: none; width: 100%; text-align: left; }
    .nav-item:hover { background: var(--green-dim); color: var(--text); }
    .nav-item.active { background: var(--green-dim); color: var(--green); border: 1px solid var(--border); }
    .nav-item .ni { font-size: 17px; width: 22px; text-align: center; flex-shrink: 0; }
    .nav-badge { margin-left: auto; background: var(--red); color: #fff; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 100px; font-family: var(--mono); display: none; }
    .sidebar-footer { padding: 14px; border-top: 1px solid var(--border); }
    .admin-chip { display: flex; align-items: center; gap:10px; padding: 10px 12px; background: var(--bg3); border-radius: 9px; }
    .admin-avatar { width: 30px; height: 30px; background: var(--green); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
    .admin-name { font-size: 13px; font-weight: 600; }
    .admin-role { font-size: 10px; color: var(--text3); font-family: var(--mono); }

    /* â”€â”€ MAIN â”€â”€ */
    .main { flex: 1; overflow-y: auto; height: 100vh; display: flex; flex-direction: column; }
    .topbar { position: sticky; top: 0; z-index: 100; background: rgba(10,15,13,.92); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); padding: 14px 28px; display: flex; align-items: center; justify-content: space-between; }
    .topbar-title { font-size: 18px; font-weight: 700; }
    .topbar-right { display: flex; align-items: center; gap: 14px; }
    .refresh-btn { background: var(--green-dim); border: 1px solid var(--border); color: var(--green); padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Syne', sans-serif; transition: all .2s; }
    .refresh-btn:hover { background: var(--green); color: #000; }
    .refresh-btn.loading { opacity: .6; pointer-events: none; }
    .live-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; animation: pulse2 2s infinite; }
    .live-label { font-size: 12px; color: var(--text2); font-family: var(--mono); display: flex; align-items: center; gap: 6px; }
    @keyframes pulse2 { 0%,100%{opacity:1;box-shadow:0 0 0 0 var(--green-glow)} 50%{opacity:.7;box-shadow:0 0 0 6px transparent} }
    .content { padding: 28px; flex: 1; }

    /* â”€â”€ PANELS â”€â”€ */
    .panel { display: none; }
    .panel.active { display: block; }

    /* â”€â”€ STATS â”€â”€ */
    .stats-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 20px 16px; position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: var(--green); opacity: .6; }
    .stat-card.amber::before { background: var(--amber); }
    .stat-card.red::before { background: var(--red); }
    .stat-card.blue::before { background: var(--blue); }
    .stat-label { font-size: 11px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 8px; font-family: var(--mono); }
    .stat-val { font-size: 32px; font-weight: 800; line-height: 1; margin-bottom: 6px; }
    .stat-sub { font-size: 12px; color: var(--text2); }
    .stat-icon { position: absolute; top: 16px; right: 16px; font-size: 24px; opacity: .4; }

    /* â”€â”€ GRID LAYOUTS â”€â”€ */
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .grid3 { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; }

    /* â”€â”€ PANEL CARD â”€â”€ */
    .pcard { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .pcard-head { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .pcard-head h3 { font-size: 15px; font-weight: 700; }
    .pcard-body { padding: 0; }
    .pcard-actions { display: flex; gap: 8px; align-items: center; }

    /* â”€â”€ TABLE â”€â”€ */
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { text-align: left; padding: 11px 16px; font-size: 10px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 1.2px; border-bottom: 1px solid var(--border); font-family: var(--mono); background: var(--bg2); }
    .data-table td { padding: 13px 16px; font-size: 13px; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .data-table tr:last-child td { border-bottom: none; }
    .data-table tr:hover td { background: var(--green-dim); }

    /* â”€â”€ BADGES â”€â”€ */
    .badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 100px; font-size: 11px; font-weight: 700; font-family: var(--mono); text-transform: uppercase; }
    .badge::before { content: ''; width: 5px; height: 5px; border-radius: 50%; background: currentColor; }
    .badge-green  { background: rgba(34,197,94,.15);  color: var(--green); border: 1px solid rgba(34,197,94,.2); }
    .badge-amber  { background: rgba(245,158,11,.15); color: var(--amber); border: 1px solid rgba(245,158,11,.2); }
    .badge-red    { background: rgba(239,68,68,.15);  color: var(--red);   border: 1px solid rgba(239,68,68,.2); }
    .badge-blue   { background: rgba(59,130,246,.15); color: var(--blue);  border: 1px solid rgba(59,130,246,.2); }
    .badge-gray   { background: rgba(255,255,255,.06); color: var(--text2); border: 1px solid var(--border); }

    /* â”€â”€ SEARCH / FILTER â”€â”€ */
    .table-controls { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .search-input { flex: 1; min-width: 200px; background: var(--bg2); border: 1px solid var(--border); color: var(--text); padding: 9px 14px; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 13px; }
    .search-input:focus { outline: none; border-color: var(--green); }
    .filter-sel { background: var(--bg2); border: 1px solid var(--border); color: var(--text); padding: 9px 12px; border-radius: 8px; font-family: 'Syne', sans-serif; font-size: 13px; cursor: pointer; }

    /* â”€â”€ ORDER DETAIL MODAL â”€â”€ */
    .detail-modal { position: fixed; inset: 0; background: rgba(0,0,0,.78); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; pointer-events: none; transition: opacity .25s; }
    .detail-modal.open { opacity: 1; pointer-events: all; }
    .detail-box { background: var(--card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 600px; max-height: 88vh; overflow-y: auto; transform: scale(.95); transition: transform .25s; }
    .detail-modal.open .detail-box { transform: scale(1); }
    .detail-box-head { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--card); z-index: 10; }
    .detail-close { width: 32px; height: 32px; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--text2); font-size: 16px; transition: all .2s; }
    .detail-close:hover { background: rgba(239,68,68,.15); color: var(--red); }
    .detail-body { padding: 24px; }
    .detail-section { margin-bottom: 20px; }
    .detail-section h4 { font-size: 11px; font-weight: 600; color: var(--text3); text-transform: uppercase; letter-spacing: 1.2px; margin-bottom: 10px; font-family: var(--mono); }
    .detail-row { display: flex; justify-content: space-between; font-size: 13px; padding: 7px 0; border-bottom: 1px solid var(--border); }
    .detail-row:last-child { border: none; }
    .detail-row span:first-child { color: var(--text2); }
    .status-update-row { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
    .status-btn { padding: 7px 14px; border-radius: 8px; font-size: 12px; font-weight: 700; border: 1px solid var(--border); cursor: pointer; font-family: 'Syne', sans-serif; transition: all .2s; background: var(--bg2); color: var(--text2); }
    .status-btn:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); }
    .status-btn.active-status { background: var(--green); color: #000; border-color: var(--green); }

    /* â”€â”€ CHARTS â”€â”€ */
    .rev-chart-area { padding: 20px; }
    .rev-bars { display: flex; align-items: flex-end; gap: 6px; height: 140px; margin-bottom: 8px; }
    .rev-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; height: 100%; justify-content: flex-end; }
    .rev-bar { width: 100%; border-radius: 5px 5px 0 0; min-height: 4px; cursor: pointer; position: relative; transition: all .3s; }
    .rev-bar.order-bar { background: linear-gradient(to top, var(--green2), var(--green)); }
    .rev-bar.sub-bar { background: linear-gradient(to top, #1d4ed8, #3b82f6); }
    .rev-bar:hover::after { content: attr(data-val); position: absolute; top: -24px; left: 50%; transform: translateX(-50%); background: var(--bg); border: 1px solid var(--border); padding: 3px 8px; border-radius: 5px; font-size: 10px; white-space: nowrap; color: var(--text); font-family: var(--mono); z-index: 10; }
    .rev-labels { display: flex; gap: 6px; }
    .rev-label { flex: 1; text-align: center; font-size: 10px; color: var(--text3); font-family: var(--mono); }
    .chart-legend { display: flex; gap: 16px; margin-top: 14px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text2); }
    .legend-dot { width: 10px; height: 10px; border-radius: 2px; }

    /* â”€â”€ TOP PRODUCTS â”€â”€ */
    .top-prod-item { padding: 12px 16px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); }
    .top-prod-item:last-child { border-bottom: none; }
    .top-prod-icon { width: 36px; height: 36px; background: var(--green-dim); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
    .top-prod-info { flex: 1; }
    .top-prod-name { font-size: 13px; font-weight: 600; margin-bottom: 2px; }
    .top-prod-cat { font-size: 11px; color: var(--text3); font-family: var(--mono); }
    .top-prod-rev { font-size: 14px; font-weight: 700; color: var(--green); font-family: var(--mono); }

    /* â”€â”€ MESSAGES â”€â”€ */
    .msg-item { padding: 16px 20px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background .2s; border-left: 3px solid transparent; }
    .msg-item:hover { background: var(--green-dim); }
    .msg-item.unread { border-left-color: var(--green); }
    .msg-item.replied { border-left-color: var(--blue); }
    .msg-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .msg-name { font-size: 14px; font-weight: 700; }
    .msg-date { font-size: 11px; color: var(--text3); font-family: var(--mono); }
    .msg-subject { font-size: 12px; color: var(--green); margin-bottom: 4px; font-weight: 600; }
    .msg-preview { font-size: 12px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 400px; }

    /* â”€â”€ PAGINATION â”€â”€ */
    .pagination { padding: 14px 16px; display: flex; align-items: center; justify-content: space-between; border-top: 1px solid var(--border); }
    .pg-info { font-size: 12px; color: var(--text3); font-family: var(--mono); }
    .pg-btns { display: flex; gap: 6px; }
    .pg-btn { width: 30px; height: 30px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg2); color: var(--text2); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all .2s; font-family: 'Syne', sans-serif; }
    .pg-btn:hover, .pg-btn.active { background: var(--green); color: #000; border-color: var(--green); }

    /* â”€â”€ QUICK ACTIONS â”€â”€ */
    .quick-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .qa-btn { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 9px; font-size: 13px; font-weight: 600; cursor: pointer; color: var(--text2); transition: all .2s; font-family: 'Syne', sans-serif; }
    .qa-btn:hover { background: var(--green-dim); color: var(--green); border-color: var(--green); }

    /* â”€â”€ EMPTY & LOADING â”€â”€ */
    .empty-state { text-align: center; padding: 48px 20px; color: var(--text3); }
    .empty-state .es-icon { font-size: 48px; display: block; margin-bottom: 12px; opacity: .5; }
    .empty-state p { font-size: 14px; }
    .loading-row td { text-align: center; padding: 40px; color: var(--text3); font-family: var(--mono); font-size: 13px; }
    .skeleton { background: linear-gradient(90deg, var(--bg2) 25%, var(--bg3) 50%, var(--bg2) 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 6px; height: 14px; }
    @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

    /* â”€â”€ TOAST â”€â”€ */
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 12px 18px; font-size: 13px; font-weight: 600; z-index: 999; transform: translateY(80px); opacity: 0; transition: all .3s; max-width: 320px; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: rgba(34,197,94,.4); color: var(--green); }
    .toast.error { border-color: rgba(239,68,68,.4); color: var(--red); }

    /* â”€â”€ COUNT TAG â”€â”€ */
    .count-tag { font-size: 11px; color: var(--text3); font-family: var(--mono); background: var(--bg2); border: 1px solid var(--border); padding: 3px 8px; border-radius: 6px; }

    /* â”€â”€ API STATUS â”€â”€ */
    .api-status { display: flex; align-items: center; gap: 6px; font-size: 11px; font-family: var(--mono); padding: 4px 10px; border-radius: 6px; border: 1px solid var(--border); }
    .api-status.ok { color: var(--green); border-color: rgba(34,197,94,.3); background: var(--green-dim); }
    .api-status.err { color: var(--red); border-color: rgba(239,68,68,.3); background: rgba(239,68,68,.08); }
    .api-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

    /* â”€â”€ VIEW BTN â”€â”€ */
    .view-btn { background: var(--green-dim); border: 1px solid var(--border); color: var(--green); padding: 5px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; font-family: 'Syne', sans-serif; transition: all .2s; }
    .view-btn:hover { background: var(--green); color: #000; }

    @media(max-width:1100px) { .stats-grid{grid-template-columns:repeat(2,1fr);} .grid3{grid-template-columns:1fr;} }
    @media(max-width:768px) { .sidebar{display:none;} .stats-grid{grid-template-columns:1fr 1fr;} .grid2{grid-template-columns:1fr;} }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-mark">ğŸŒ¿</div>
    <div>
      <div class="logo-name">Milqu<span> Fresh</span></div>
      <div class="logo-sub">Admin Panel</div>
    </div>
  </div>
  <nav class="nav">
    <button class="nav-item active" onclick="showPanel('overview',this)"><span class="ni">ğŸ“Š</span> Overview</button>
    <button class="nav-item" onclick="showPanel('orders',this)"><span class="ni">ğŸ›’</span> Orders <span class="nav-badge" id="nb-orders">0</span></button>
    <button class="nav-item" onclick="showPanel('subscriptions',this)"><span class="ni">ğŸ“¦</span> Subscriptions <span class="nav-badge" id="nb-subs">0</span></button>
    <button class="nav-item" onclick="showPanel('messages',this)"><span class="ni">ğŸ’¬</span> Messages <span class="nav-badge" id="nb-msgs">0</span></button>
    <button class="nav-item" onclick="showPanel('products',this)"><span class="ni">ğŸ¥›</span> Products</button>
    <div style="height:1px;background:var(--border);margin:8px 0;"></div>
    <a href="index.html" target="_blank" class="nav-item" style="color:var(--text2);text-decoration:none;"><span class="ni">ğŸŒ</span> View Website</a>
  </nav>
  <div class="sidebar-footer">
    <div class="admin-chip">
      <div class="admin-avatar">ğŸ‘¨â€ğŸ’¼</div>
      <div>
        <div class="admin-name">Admin</div>
        <div class="admin-role">super admin</div>
      </div>
    </div>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="panel-title">ğŸ“Š Overview</div>
    <div class="topbar-right">
      <div class="api-status" id="api-status"><div class="api-dot"></div><span id="api-status-text">Connectingâ€¦</span></div>
      <div class="live-label"><div class="live-dot"></div> Live</div>
      <button class="refresh-btn" id="refresh-btn" onclick="loadAll()">â†» Refresh</button>
    </div>
  </div>

  <div class="content">

    <!-- â•â• OVERVIEW PANEL â•â• -->
    <div class="panel active" id="panel-overview">
      <div class="stats-grid" id="overview-stats">
        <!-- skeleton -->
        <div class="stat-card"><div class="stat-label">Loadingâ€¦</div><div class="skeleton" style="height:36px;width:80px;margin-bottom:8px;"></div><div class="skeleton" style="width:120px;"></div></div>
        <div class="stat-card amber"><div class="stat-label">Loadingâ€¦</div><div class="skeleton" style="height:36px;width:80px;margin-bottom:8px;"></div><div class="skeleton" style="width:120px;"></div></div>
        <div class="stat-card red"><div class="stat-label">Loadingâ€¦</div><div class="skeleton" style="height:36px;width:80px;margin-bottom:8px;"></div><div class="skeleton" style="width:120px;"></div></div>
        <div class="stat-card blue"><div class="stat-label">Loadingâ€¦</div><div class="skeleton" style="height:36px;width:80px;margin-bottom:8px;"></div><div class="skeleton" style="width:120px;"></div></div>
      </div>
      <div class="quick-actions">
        <button class="qa-btn" onclick="showPanel('orders',document.querySelector('[onclick*=orders]'))">ğŸ›’ Manage Orders</button>
        <button class="qa-btn" onclick="showPanel('messages',document.querySelector('[onclick*=messages]'))">ğŸ’¬ View Messages</button>
        <button class="qa-btn" onclick="showPanel('subscriptions',document.querySelector('[onclick*=subscriptions]'))">ğŸ“¦ Subscriptions</button>
        <button class="qa-btn" onclick="loadAll()">ğŸ”„ Refresh All Data</button>
      </div>
      <div class="grid3" style="margin-bottom:20px;">
        <div class="pcard">
          <div class="pcard-head">
            <h3>Revenue (7 days)</h3>
            <div class="chart-legend">
              <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Orders</div>
              <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>Subscriptions</div>
            </div>
          </div>
          <div class="rev-chart-area" id="rev-chart"><div class="empty-state"><span class="es-icon">ğŸ“ˆ</span><p>Loading chartâ€¦</p></div></div>
        </div>
        <div class="pcard">
          <div class="pcard-head"><h3>Top Products</h3></div>
          <div id="top-products-list"><div class="empty-state"><span class="es-icon">ğŸ“Š</span><p>Loadingâ€¦</p></div></div>
        </div>
      </div>
      <div class="grid2">
        <div class="pcard">
          <div class="pcard-head"><h3>Recent Orders</h3><span class="count-tag" id="recent-orders-count">â€”</span></div>
          <table class="data-table">
            <thead><tr><th>Order ID</th><th>Customer</th><th>Total</th><th>Status</th></tr></thead>
            <tbody id="recent-orders-body"><tr class="loading-row"><td colspan="4">â³ Loading ordersâ€¦</td></tr></tbody>
          </table>
        </div>
        <div class="pcard">
          <div class="pcard-head"><h3>Recent Messages</h3><span class="count-tag" id="recent-msgs-count">â€”</span></div>
          <div id="recent-msgs-list"><div class="empty-state"><span class="es-icon">ğŸ’¬</span><p>Loadingâ€¦</p></div></div>
        </div>
      </div>
    </div>

    <!-- â•â• ORDERS PANEL â•â• -->
    <div class="panel" id="panel-orders">
      <div class="pcard">
        <div class="table-controls">
          <input type="text" class="search-input" id="order-search" placeholder="Search by order ID, name, phoneâ€¦" oninput="filterOrders()">
          <select class="filter-sel" id="order-status-filter" onchange="filterOrders()">
            <option value="">All Status</option>
            <option value="confirmed">Confirmed</option>
            <option value="pending">Pending</option>
            <option value="out_for_delivery">Out for Delivery</option>
            <option value="delivered">Delivered</option>
            <option value="cancelled">Cancelled</option>
          </select>
          <select class="filter-sel" id="order-pay-filter" onchange="filterOrders()">
            <option value="">All Payments</option>
            <option value="upi">UPI</option>
            <option value="card">Card</option>
            <option value="netbanking">Net Banking</option>
            <option value="cod">COD</option>
          </select>
        </div>
        <table class="data-table">
          <thead><tr><th>Order ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Payment</th><th>Status</th><th>Date</th><th>Action</th></tr></thead>
          <tbody id="orders-body"><tr class="loading-row"><td colspan="8">â³ Loading ordersâ€¦</td></tr></tbody>
        </table>
        <div class="pagination">
          <div class="pg-info" id="orders-pg-info">â€”</div>
          <div class="pg-btns" id="orders-pg-btns"></div>
        </div>
      </div>
    </div>

    <!-- â•â• SUBSCRIPTIONS PANEL â•â• -->
    <div class="panel" id="panel-subscriptions">
      <div class="pcard">
        <div class="table-controls">
          <input type="text" class="search-input" id="sub-search" placeholder="Search subscriptions by name, phoneâ€¦" oninput="filterSubs()">
          <select class="filter-sel" id="sub-status-filter" onchange="filterSubs()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="paused">Paused</option>
            <option value="cancelled">Cancelled</option>
          </select>
        </div>
        <table class="data-table">
          <thead><tr><th>Sub ID</th><th>Customer</th><th>Milk Type</th><th>Qty/Day</th><th>Schedule</th><th>Monthly</th><th>Payment</th><th>Status</th><th>Start Date</th><th>Action</th></tr></thead>
          <tbody id="subs-body"><tr class="loading-row"><td colspan="9">â³ Loading subscriptionsâ€¦</td></tr></tbody>
        </table>
        <div class="pagination"><div class="pg-info" id="subs-pg-info">â€”</div></div>
      </div>
    </div>

    <!-- â•â• MESSAGES PANEL â•â• -->
    <div class="panel" id="panel-messages">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
        <div class="pcard">
          <div class="pcard-head">
            <h3>Inbox</h3>
            <select class="filter-sel" id="msg-filter" onchange="filterMsgs()" style="font-size:12px;padding:6px 10px;">
              <option value="">All</option>
              <option value="unread">Unread</option>
              <option value="read">Read</option>
              <option value="replied">Replied</option>
            </select>
          </div>
          <div id="messages-list"><div class="empty-state"><span class="es-icon">ğŸ’¬</span><p>Loadingâ€¦</p></div></div>
        </div>
        <div class="pcard" id="msg-detail-panel">
          <div class="pcard-head"><h3>Message Detail</h3></div>
          <div style="padding:40px 20px;text-align:center;color:var(--text3);">
            <div style="font-size:40px;margin-bottom:12px;">ğŸ’¬</div>
            <p style="font-size:14px;">Select a message to view details</p>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• PRODUCTS PANEL â•â• -->
    <div class="panel" id="panel-products">
      <div class="pcard">
        <div class="pcard-head"><h3>ğŸ¥› Product Catalog</h3><span class="count-tag">18 products</span></div>
        <table class="data-table">
          <thead><tr><th>Icon</th><th>Name</th><th>Category</th><th>Price</th><th>Unit</th><th>Badge</th></tr></thead>
          <tbody id="products-body"></tbody>
        </table>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ORDER DETAIL MODAL -->
<div class="detail-modal" id="order-modal">
  <div class="detail-box">
    <div class="detail-box-head">
      <div>
        <div style="font-size:16px;font-weight:800;" id="modal-order-id">Order #</div>
        <div style="font-size:11px;color:var(--text3);font-family:var(--mono);" id="modal-order-date"></div>
      </div>
      <button class="detail-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="detail-body" id="modal-content"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG â€” change this to your deployed backend URL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = 'http://localhost:5000/api';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRODUCTS CATALOG (static â€” same as frontend)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const P = [
  {id:'m1',name:'Cow Milk',e:'ğŸ¥›',price:60,unit:'/L',cat:'milk',badge:'Fresh'},
  {id:'m2',name:'Buffalo Milk',e:'ğŸ¼',price:75,unit:'/L',cat:'milk',badge:'Popular'},
  {id:'m3',name:'Organic Milk',e:'ğŸŒ¿',price:90,unit:'/L',cat:'milk',badge:'Organic'},
  {id:'v1',name:'Fresh Tomatoes',e:'ğŸ…',price:40,unit:'/kg',cat:'vegetables',badge:null},
  {id:'v2',name:'Potatoes',e:'ğŸ¥”',price:30,unit:'/kg',cat:'vegetables',badge:null},
  {id:'v3',name:'Red Onions',e:'ğŸ§…',price:35,unit:'/kg',cat:'vegetables',badge:null},
  {id:'v4',name:'Spinach',e:'ğŸ¥¬',price:30,unit:'/bunch',cat:'vegetables',badge:null},
  {id:'v5',name:'Carrots',e:'ğŸ¥•',price:45,unit:'/kg',cat:'vegetables',badge:'Fresh'},
  {id:'d1',name:'Pure Ghee',e:'ğŸ«™',price:580,unit:'/500g',cat:'dairy',badge:'Best Seller'},
  {id:'d2',name:'Fresh Paneer',e:'ğŸ§€',price:90,unit:'/200g',cat:'dairy',badge:null},
  {id:'d3',name:'White Butter',e:'ğŸ§ˆ',price:120,unit:'/200g',cat:'dairy',badge:null},
  {id:'d4',name:'Curd',e:'ğŸ¥£',price:50,unit:'/500g',cat:'dairy',badge:'Probiotic'},
  {id:'d5',name:'Cheese',e:'ğŸ«•',price:160,unit:'/200g',cat:'dairy',badge:null},
  {id:'f1',name:'Apples',e:'ğŸ',price:180,unit:'/kg',cat:'fruits',badge:'Imported'},
  {id:'f2',name:'Bananas',e:'ğŸŒ',price:50,unit:'/dozen',cat:'fruits',badge:null},
  {id:'f3',name:'Alphonso Mango',e:'ğŸ¥­',price:120,unit:'/kg',cat:'fruits',badge:'Seasonal'},
  {id:'f4',name:'Oranges',e:'ğŸŠ',price:80,unit:'/kg',cat:'fruits',badge:null},
  {id:'f5',name:'Papaya',e:'ğŸˆ',price:60,unit:'/kg',cat:'fruits',badge:null},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let allOrders = [], allSubs = [], allMsgs = [];
let filteredOrders = [], ordPage = 0;
const PER_PAGE = 10;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(d)     { return new Date(d).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}); }
function fmtDate(d) { return new Date(d).toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'}); }

function statusBadge(s) {
  const m = {
    confirmed:'badge-green', pending:'badge-amber', out_for_delivery:'badge-blue',
    delivered:'badge-blue', cancelled:'badge-red',
    active:'badge-green', paused:'badge-amber',
    unread:'badge-amber', read:'badge-gray', replied:'badge-blue'
  };
  return `<span class="badge ${m[s]||'badge-gray'}">${(s||'').replace(/_/g,' ')}</span>`;
}
function payBadge(p) {
  const icons = {upi:'ğŸ“±',card:'ğŸ’³',netbanking:'ğŸ¦',cod:'ğŸ’µ'};
  return `<span style="font-size:13px;">${icons[p]||'ğŸ’°'} ${(p||'').toUpperCase()}</span>`;
}

function toast(msg, type='success') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast show ${type}`;
  setTimeout(()=>t.classList.remove('show'), 3200);
}

function setApiStatus(ok) {
  const el = document.getElementById('api-status');
  const txt = document.getElementById('api-status-text');
  el.className = 'api-status ' + (ok ? 'ok' : 'err');
  txt.textContent = ok ? 'MongoDB Connected' : 'Server Offline';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API CALLS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function apiFetch(path) {
  const res = await fetch(API_BASE + path);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

async function apiPatch(path, body) {
  const res = await fetch(API_BASE + path, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PANEL NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const titles = {overview:'ğŸ“Š Overview',orders:'ğŸ›’ Orders',subscriptions:'ğŸ“¦ Subscriptions',messages:'ğŸ’¬ Messages',products:'ğŸ¥› Products'};
  document.getElementById('panel-title').textContent = titles[id] || id;
  if (id === 'orders') renderOrders();
  if (id === 'subscriptions') renderSubs();
  if (id === 'messages') renderMessages();
  if (id === 'products') renderProducts();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOAD ALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAll() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('loading');
  btn.textContent = 'â†» Loadingâ€¦';

  try {
    // Check server health
    await fetch(API_BASE + '/health');
    setApiStatus(true);

    // Parallel fetch
    const [ordRes, subRes, msgRes] = await Promise.all([
      apiFetch('/orders?limit=200'),
      apiFetch('/subscriptions?limit=200'),
      apiFetch('/messages?limit=200')
    ]);

    allOrders = ordRes.orders || [];
    allSubs   = subRes.subscriptions || [];
    allMsgs   = msgRes.messages || [];

    // Update nav badges
    const pendingOrds = allOrders.filter(o => o.status === 'pending' || o.status === 'confirmed').length;
    const activeSubs  = allSubs.filter(s => s.status === 'active').length;
    const unreadMsgs  = allMsgs.filter(m => m.status === 'unread').length;

    setBadge('nb-orders', pendingOrds);
    setBadge('nb-subs', activeSubs);
    setBadge('nb-msgs', unreadMsgs);

    renderOverview();
    toast('âœ… Data refreshed from MongoDB');
  } catch (err) {
    console.error('Load error:', err);
    setApiStatus(false);
    toast('âŒ Cannot reach server. Is it running on port 5000?', 'error');
  }

  btn.classList.remove('loading');
  btn.textContent = 'â†» Refresh';
}

function setBadge(id, count) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = count;
  el.style.display = count > 0 ? 'inline' : 'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OVERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOverview() {
  const totalRev  = allOrders.reduce((s, o) => s + (o.total || 0), 0);
  const activeSub = allSubs.filter(s => s.status === 'active').length;
  const unread    = allMsgs.filter(m => m.status === 'unread').length;
  const todayStr  = new Date().toDateString();
  const today     = allOrders.filter(o => new Date(o.createdAt).toDateString() === todayStr).length;

  document.getElementById('overview-stats').innerHTML = `
    <div class="stat-card">
      <div class="stat-label">Total Revenue</div>
      <div class="stat-val" style="color:var(--green);">â‚¹${totalRev.toLocaleString()}</div>
      <div class="stat-sub">${allOrders.length} total orders</div>
      <div class="stat-icon">ğŸ’°</div>
    </div>
    <div class="stat-card amber">
      <div class="stat-label">Active Subscriptions</div>
      <div class="stat-val" style="color:var(--amber);">${activeSub}</div>
      <div class="stat-sub">of ${allSubs.length} total</div>
      <div class="stat-icon">ğŸ“¦</div>
    </div>
    <div class="stat-card red">
      <div class="stat-label">Unread Messages</div>
      <div class="stat-val" style="color:var(--red);">${unread}</div>
      <div class="stat-sub">${allMsgs.length} total messages</div>
      <div class="stat-icon">ğŸ’¬</div>
    </div>
    <div class="stat-card blue">
      <div class="stat-label">Orders Today</div>
      <div class="stat-val" style="color:var(--blue);">${today}</div>
      <div class="stat-sub">vs ${allOrders.length} total</div>
      <div class="stat-icon">ğŸ›’</div>
    </div>`;

  // Revenue chart â€” group orders by day of week
  const days = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
  const dayRevs = [0,0,0,0,0,0,0];
  allOrders.forEach(o => {
    const d = new Date(o.createdAt).getDay(); // 0=Sun
    const idx = d === 0 ? 6 : d - 1;
    dayRevs[idx] += (o.total || 0);
  });
  const maxRev = Math.max(...dayRevs, 1);
  const bars = days.map((d,i) => `
    <div class="rev-bar-wrap">
      <div class="rev-bar order-bar" style="height:${(dayRevs[i]/maxRev*100).toFixed(0)}%;" data-val="â‚¹${dayRevs[i].toLocaleString()}"></div>
    </div>`).join('');
  const labels = days.map(d => `<div class="rev-label">${d}</div>`).join('');
  document.getElementById('rev-chart').innerHTML = `
    <div class="rev-bars">${bars}</div>
    <div class="rev-labels">${labels}</div>
    <div class="chart-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--green)"></div>Order Revenue</div>
    </div>`;

  // Top products
  const prodSales = {};
  allOrders.forEach(o => (o.items || []).forEach(i => { prodSales[i.id] = (prodSales[i.id]||0) + (i.price * i.qty); }));
  const sorted = Object.entries(prodSales).sort((a,b) => b[1]-a[1]).slice(0,5);
  document.getElementById('top-products-list').innerHTML = sorted.map(([id,rev]) => {
    const prod = P.find(p => p.id === id);
    if (!prod) return '';
    return `<div class="top-prod-item">
      <div class="top-prod-icon">${prod.e}</div>
      <div class="top-prod-info">
        <div class="top-prod-name">${prod.name}</div>
        <div class="top-prod-cat">${prod.cat}</div>
      </div>
      <div class="top-prod-rev">â‚¹${rev.toLocaleString()}</div>
    </div>`;
  }).join('') || `<div class="empty-state"><span class="es-icon">ğŸ“Š</span><p>No sales data yet</p></div>`;

  // Recent orders
  const recentOrds = [...allOrders].sort((a,b) => new Date(b.createdAt)-new Date(a.createdAt)).slice(0,5);
  document.getElementById('recent-orders-count').textContent = allOrders.length + ' orders';
  document.getElementById('recent-orders-body').innerHTML = recentOrds.map(o => `
    <tr onclick="openOrderModal('${o.orderId}')" style="cursor:pointer;">
      <td><span style="font-family:var(--mono);color:var(--green);font-size:12px;">#${o.orderId}</span></td>
      <td><strong>${o.customer?.name||'â€”'}</strong></td>
      <td style="font-family:var(--mono);">â‚¹${(o.total||0).toFixed(0)}</td>
      <td>${statusBadge(o.status)}</td>
    </tr>`).join('') || '<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--text3);">No orders yet</td></tr>';

  // Recent messages
  const recentMsgs = [...allMsgs].sort((a,b) => new Date(b.createdAt)-new Date(a.createdAt)).slice(0,4);
  document.getElementById('recent-msgs-count').textContent = allMsgs.length + ' msgs';
  document.getElementById('recent-msgs-list').innerHTML = recentMsgs.map(m => `
    <div class="msg-item ${m.status}" onclick="showPanel('messages',document.querySelector('[onclick*=messages]'));setTimeout(()=>openMsg('${m.messageId}'),100)">
      <div class="msg-head"><span class="msg-name">${m.name}</span><span class="msg-date">${fmt(m.createdAt)}</span></div>
      <div class="msg-subject">${m.subject}</div>
      <div class="msg-preview">${m.message}</div>
    </div>`).join('') || `<div class="empty-state"><span class="es-icon">ğŸ’¬</span><p>No messages yet</p></div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderOrders() { filteredOrders = [...allOrders]; filterOrders(); }

function filterOrders() {
  const q  = (document.getElementById('order-search')?.value || '').toLowerCase();
  const st = document.getElementById('order-status-filter')?.value || '';
  const pm = document.getElementById('order-pay-filter')?.value || '';
  filteredOrders = allOrders.filter(o => {
    const mQ = !q  || (o.orderId?.toLowerCase().includes(q)) || (o.customer?.name?.toLowerCase().includes(q)) || (o.customer?.phone?.includes(q));
    const mS = !st || o.status === st;
    const mP = !pm || o.paymentMethod === pm;
    return mQ && mS && mP;
  });
  ordPage = 0;
  renderOrdersPage();
}

function renderOrdersPage() {
  const start = ordPage * PER_PAGE, end = start + PER_PAGE;
  const page = filteredOrders.slice(start, end);
  document.getElementById('orders-body').innerHTML = page.map(o => `
    <tr>
      <td><span style="font-family:var(--mono);color:var(--green);font-size:12px;">#${o.orderId}</span></td>
      <td>
        <div style="font-weight:600;">${o.customer?.name||'â€”'}</div>
        <div style="font-size:11px;color:var(--text3);font-family:var(--mono);">${o.customer?.phone||''}</div>
      </td>
      <td style="font-size:12px;color:var(--text2);">${(o.items||[]).map(i=>`${i.e||''}${i.name}Ã—${i.qty}`).join(', ').substring(0,50)}</td>
      <td><span style="font-family:var(--mono);font-weight:700;">â‚¹${(o.total||0).toFixed(0)}</span></td>
      <td>${payBadge(o.paymentMethod)}</td>
      <td>${statusBadge(o.status)}</td>
      <td style="font-size:12px;color:var(--text3);font-family:var(--mono);">${fmtDate(o.createdAt)}</td>
      <td><button class="view-btn" onclick="openOrderModal('${o.orderId}')">View</button></td>
    </tr>`).join('') || `<tr><td colspan="8"><div class="empty-state"><span class="es-icon">ğŸ›’</span><p>No orders found</p></div></td></tr>`;

  document.getElementById('orders-pg-info').textContent = `Showing ${Math.min(start+1,filteredOrders.length)}â€“${Math.min(end,filteredOrders.length)} of ${filteredOrders.length}`;
  const totalPgs = Math.ceil(filteredOrders.length / PER_PAGE);
  let pgHtml = '';
  for (let i = 0; i < totalPgs; i++) pgHtml += `<button class="pg-btn ${i===ordPage?'active':''}" onclick="ordPage=${i};renderOrdersPage()">${i+1}</button>`;
  document.getElementById('orders-pg-btns').innerHTML = pgHtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ORDER MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openOrderModal(orderId) {
  const o = allOrders.find(x => x.orderId === orderId);
  if (!o) return;
  document.getElementById('modal-order-id').textContent = `Order #${o.orderId}`;
  document.getElementById('modal-order-date').textContent = fmt(o.createdAt);
  const items = (o.items||[]).map(i => `
    <div class="detail-row">
      <span>${i.e||''} ${i.name} Ã— ${i.qty}</span>
      <strong style="font-family:var(--mono);">â‚¹${((i.price||0)*(i.qty||1)).toFixed(0)}</strong>
    </div>`).join('');

  document.getElementById('modal-content').innerHTML = `
    <div class="detail-section">
      <h4>Customer Info</h4>
      <div class="detail-row"><span>Name</span><strong>${o.customer?.name||'â€”'}</strong></div>
      <div class="detail-row"><span>Phone</span><strong style="font-family:var(--mono);">${o.customer?.phone||'â€”'}</strong></div>
      <div class="detail-row"><span>Email</span><strong>${o.customer?.email||'â€”'}</strong></div>
      <div class="detail-row"><span>Address</span><strong>${o.customer?.address||'â€”'}</strong></div>
      ${o.customer?.notes?`<div class="detail-row"><span>Notes</span><strong>${o.customer.notes}</strong></div>`:''}
    </div>
    <div class="detail-section">
      <h4>Order Items</h4>
      ${items}
      <div class="detail-row" style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px;">
        <span>Total</span>
        <strong style="font-family:var(--mono);color:var(--green);font-size:16px;">â‚¹${(o.total||0).toFixed(0)}</strong>
      </div>
    </div>
    <div class="detail-section">
      <h4>Payment & Status</h4>
      <div class="detail-row"><span>Method</span>${payBadge(o.paymentMethod)}</div>
      <div class="detail-row"><span>Payment Status</span>${statusBadge(o.paymentStatus||'pending')}</div>
      <div class="detail-row"><span>Order Status</span>${statusBadge(o.status)}</div>
    </div>
    <div class="detail-section">
      <h4>Update Order Status</h4>
      <div class="status-update-row">
        ${['confirmed','out_for_delivery','delivered','cancelled'].map(s =>
          `<button class="status-btn ${o.status===s?'active-status':''}" onclick="updateOrderStatus('${o.orderId}','${s}',this)">${s.replace(/_/g,' ')}</button>`
        ).join('')}
      </div>
    </div>`;
  document.getElementById('order-modal').classList.add('open');
}

function closeModal() { document.getElementById('order-modal').classList.remove('open'); }
document.getElementById('order-modal').addEventListener('click', function(e){ if(e.target===this) closeModal(); });

async function updateOrderStatus(orderId, status, btn) {
  try {
    const result = await apiPatch(`/orders/${orderId}/status`, { status });
    if (result.success) {
      // Update local data
      const idx = allOrders.findIndex(o => o.orderId === orderId);
      if (idx >= 0) allOrders[idx].status = status;
      // Update UI
      document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('active-status'));
      btn.classList.add('active-status');
      renderOrdersPage();
      toast(`âœ… Order status updated to "${status.replace(/_/g,' ')}"`);
    } else {
      toast('âŒ ' + result.message, 'error');
    }
  } catch {
    toast('âŒ Failed to update status', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUBSCRIPTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSubs() { filterSubs(); }

function filterSubs() {
  const q  = (document.getElementById('sub-search')?.value || '').toLowerCase();
  const st = document.getElementById('sub-status-filter')?.value || '';
  const filtered = allSubs.filter(s => {
    const mQ = !q  || s.name?.toLowerCase().includes(q) || s.phone?.includes(q);
    const mS = !st || s.status === st;
    return mQ && mS;
  });
  const milkLabels = {cow:'ğŸ¥› Cow',buffalo:'ğŸ¼ Buffalo',organic:'ğŸŒ¿ Organic'};
  const schedLabels = {daily:'ğŸ“… Daily',alternate:'ğŸ“† Alt Days',weekdays:'ğŸ—“ Weekdays',custom:'âœï¸ Custom'};

  document.getElementById('subs-body').innerHTML = filtered.map(s => `
    <tr>
      <td><span style="font-family:var(--mono);color:var(--green);font-size:12px;">#${s.subscriptionId}</span></td>
      <td>
        <div style="font-weight:600;">${s.name}</div>
        <div style="font-size:11px;color:var(--text3);font-family:var(--mono);">${s.phone}</div>
      </td>
      <td>${milkLabels[s.milkType]||s.milkType}</td>
      <td><strong style="font-family:var(--mono);">${s.qty} L</strong></td>
      <td>${schedLabels[s.schedule]||s.schedule}</td>
      <td><strong style="font-family:var(--mono);color:var(--green);">${s.monthlyTotal||'â€”'}</strong></td>
      <td>${payBadge(s.paymentMethod||'upi')}</td>
      <td>${statusBadge(s.status)}</td>
      <td style="font-size:12px;color:var(--text3);font-family:var(--mono);">${s.startDate||fmtDate(s.createdAt)}</td>
      <td>
        <select onchange="updateSubStatus('${s.subscriptionId}',this.value)" style="background:var(--bg2);border:1px solid var(--border);color:var(--text2);padding:4px 8px;border-radius:6px;font-size:12px;font-family:'Syne',sans-serif;cursor:pointer;">
          <option value="">Changeâ€¦</option>
          <option value="active">Activate</option>
          <option value="paused">Pause</option>
          <option value="cancelled">Cancel</option>
        </select>
      </td>
    </tr>`).join('') || `<tr><td colspan="9"><div class="empty-state"><span class="es-icon">ğŸ“¦</span><p>No subscriptions found</p></div></td></tr>`;

  document.getElementById('subs-pg-info').textContent = `Showing ${filtered.length} of ${allSubs.length}`;
}

async function updateSubStatus(subscriptionId, status) {
  if (!status) return;
  try {
    const result = await apiPatch(`/subscriptions/${subscriptionId}/status`, { status });
    if (result.success) {
      const idx = allSubs.findIndex(s => s.subscriptionId === subscriptionId);
      if (idx >= 0) allSubs[idx].status = status;
      filterSubs();
      toast(`âœ… Subscription ${status}`);
    } else {
      toast('âŒ ' + result.message, 'error');
    }
  } catch {
    toast('âŒ Failed to update subscription', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMessages() { filterMsgs(); }

function filterMsgs() {
  const filter = document.getElementById('msg-filter')?.value || '';
  const msgs = [...allMsgs].sort((a,b) => new Date(b.createdAt)-new Date(a.createdAt));
  const filtered = filter ? msgs.filter(m => m.status === filter) : msgs;

  document.getElementById('messages-list').innerHTML = filtered.map(m => `
    <div class="msg-item ${m.status}" onclick="openMsg('${m.messageId}')">
      <div class="msg-head">
        <span class="msg-name">${m.name}</span>
        <div style="display:flex;align-items:center;gap:8px;">${statusBadge(m.status)}<span class="msg-date">${fmt(m.createdAt)}</span></div>
      </div>
      <div class="msg-subject">${m.subject}</div>
      <div class="msg-preview">${m.message}</div>
    </div>`).join('') || `<div class="empty-state"><span class="es-icon">ğŸ’¬</span><p>No messages</p></div>`;
}

async function openMsg(messageId) {
  const m = allMsgs.find(x => x.messageId === messageId);
  if (!m) return;

  // Mark as read if unread
  if (m.status === 'unread') {
    try {
      await apiPatch(`/messages/${messageId}/status`, { status: 'read' });
      const idx = allMsgs.findIndex(x => x.messageId === messageId);
      if (idx >= 0) allMsgs[idx].status = 'read';
      filterMsgs();
      setBadge('nb-msgs', allMsgs.filter(x => x.status === 'unread').length);
    } catch {}
  }

  document.getElementById('msg-detail-panel').innerHTML = `
    <div class="pcard-head"><h3>ğŸ’¬ Message Detail</h3>${statusBadge(m.status)}</div>
    <div style="padding:20px;">
      <div style="margin-bottom:16px;">
        <div style="font-size:18px;font-weight:800;margin-bottom:4px;">${m.name}</div>
        <div style="font-size:12px;color:var(--text3);font-family:var(--mono);">${m.email}${m.phone?' Â· '+m.phone:''}</div>
        <div style="font-size:11px;color:var(--text3);font-family:var(--mono);margin-top:4px;">${fmt(m.createdAt)}</div>
      </div>
      <div style="background:var(--green-dim);border:1px solid var(--border);border-radius:9px;padding:6px 12px;margin-bottom:14px;">
        <div style="font-size:11px;color:var(--green);font-weight:700;text-transform:uppercase;letter-spacing:1px;">Subject</div>
        <div style="font-size:14px;font-weight:600;margin-top:2px;">${m.subject}</div>
      </div>
      <div style="background:var(--bg2);border:1px solid var(--border);border-radius:9px;padding:14px;font-size:14px;color:var(--text2);line-height:1.8;margin-bottom:20px;">${m.message}</div>
      <div>
        <div style="font-size:12px;font-weight:700;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;font-family:var(--mono);">Quick Reply</div>
        <textarea id="reply-input" placeholder="Type your replyâ€¦" style="width:100%;background:var(--bg2);border:1px solid var(--border);color:var(--text);padding:12px;border-radius:9px;font-family:'Syne',sans-serif;font-size:13px;resize:vertical;min-height:80px;outline:none;"></textarea>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <button onclick="markReplied('${m.messageId}')" style="background:var(--green);color:#000;border:none;padding:9px 18px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;">âœ‰ï¸ Mark as Replied</button>
        </div>
      </div>
    </div>`;
}

async function markReplied(messageId) {
  try {
    await apiPatch(`/messages/${messageId}/status`, { status: 'replied' });
    const idx = allMsgs.findIndex(m => m.messageId === messageId);
    if (idx >= 0) allMsgs[idx].status = 'replied';
    filterMsgs();
    openMsg(messageId);
    toast('âœ… Message marked as replied');
  } catch {
    toast('âŒ Failed to update message', 'error');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRODUCTS (static)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProducts() {
  document.getElementById('products-body').innerHTML = P.map(p => `
    <tr>
      <td style="font-size:26px;">${p.e}</td>
      <td><strong>${p.name}</strong></td>
      <td><span class="badge badge-gray">${p.cat}</span></td>
      <td><strong style="font-family:var(--mono);">â‚¹${p.price}</strong></td>
      <td style="font-family:var(--mono);color:var(--text2);">${p.unit}</td>
      <td>${p.badge ? `<span class="badge badge-green">${p.badge}</span>` : '<span style="color:var(--text3);">â€”</span>'}</td>
    </tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadAll();
</script>
</body>
</html>